{
  type = "custom-api";
  title = "Media Server";
  hide-header = true;
  cache = "5m";
  options = {
    media-server = "plex";
    base-url = "http://localhost:32400";
    api-key = {
      _secret = "/run/secrets/plex_token";
    };
    small-column = false;
    compact = true;
    play-state = "indicator";
    show-thumbnail = false;
    full-thumbnail = false;
    show-paused = false;
    show-progress-bar = false;
    show-progress-info = true;
    time-format = "15:04";
  };
  template = "{{ $mediaServer := .Options.StringOr \"media-server\" \"\" }}\n{{ $baseURL := .Options.StringOr \"base-url\" \"\" }}\n{{ $apiKey := .Options.StringOr \"api-key\" \"\" }}\n\n{{ define \"errorMsg\" }}\n  <div class=\"widget-error-header\">\n    <div class=\"color-negative size-h3\">ERROR</div>\n    <svg class=\"widget-error-icon\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke-width=\"1.5\">\n      <path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z\"></path>\n    </svg>\n  </div>\n  <p class=\"break-all\">{{ . }}</p>\n{{ end }}\n\n{{ if or\n  (eq $mediaServer \"\")\n  (eq $baseURL \"\")\n  (eq $apiKey \"\")\n}}\n  {{ template \"errorMsg\" \"Some required options are not set\" }}\n{{ else }}\n\n{{ $isSmallColumn := .Options.BoolOr \"small-column\" false }}\n{{ $isCompact := .Options.BoolOr \"compact\" true }}\n{{ $playState := .Options.StringOr \"play-state\" \"indicator\" }}\n{{ $showThumbnail := .Options.BoolOr \"show-thumbnail\" false }}\n{{ $fullThumbnail := .Options.BoolOr \"full-thumbnail\" false }}\n{{ $showPaused := .Options.BoolOr \"show-paused\" false }}\n{{ $showProgressBar := .Options.BoolOr \"show-progress-bar\" false }}\n{{ $showProgressInfo := .Options.BoolOr \"show-progress-info\" true }}\n{{ $timeFormat := .Options.StringOr \"time-format\" \"15:04\" }}\n\n{{ $userID := \"\" }}\n{{ $sessionsRequestURL := \"\" }}\n{{ $sessionsCall := \"\" }}\n{{ $sessions := \"\" }}\n{{ $activeSessions := 0 }}\n\n{{ if eq $mediaServer \"plex\" }}\n  {{ $sessionsRequestURL = concat $baseURL \"/status/sessions\" }}\n  {{ $sessionsCall = newRequest $sessionsRequestURL\n    | withHeader \"Accept\" \"application/json\"\n    | withHeader \"X-Plex-Token\" $apiKey\n    | getResponse }}\n\n  {{ if $sessionsCall.JSON.Exists \"MediaContainer\" }}\n    {{ $sessions = $sessionsCall.JSON.Array \"MediaContainer.Metadata\" }}\n    {{ $activeSessions = len $sessions }}\n  {{ else }}\n    {{ template \"errorMsg\" (concat \"Could not fetch \" $mediaServer \" API.\") }}\n  {{ end }}\n\n{{ else if eq $mediaServer \"tautulli\" }}\n  {{ $sessionsRequestURL = concat $baseURL \"/api/v2\" }}\n  {{ $sessionsCall = newRequest $sessionsRequestURL\n    | withParameter \"apikey\" $apiKey\n    | withParameter \"cmd\" \"get_activity\"\n    | withHeader \"Accept\" \"application/json\"\n    | getResponse }}\n\n  {{ if eq $sessionsCall.Response.StatusCode 200 }}\n    {{ $sessions = $sessionsCall.JSON.Array \"response.data.sessions\" }}\n    {{ $activeSessions = len $sessions }}\n  {{ else }}\n    {{ template \"errorMsg\" (concat \"Could not fetch \" $mediaServer \" API.\") }}\n  {{ end }}\n\n{{ else if or (eq $mediaServer \"jellyfin\") (eq $mediaServer \"emby\") }}\n  {{ $sessionsRequestURL = concat $baseURL \"/Sessions\" }}\n  {{ $sessionsCall = newRequest $sessionsRequestURL\n    | withParameter \"api_key\" $apiKey\n    | withParameter \"activeWithinSeconds\" \"30\"\n    | withHeader \"Accept\" \"application/json\"\n    | getResponse }}\n\n  {{ if eq $sessionsCall.Response.StatusCode 200 }}\n    {{ $sessions = $sessionsCall.JSON.Array \"\" }}\n    {{ if eq $mediaServer \"emby\" }}\n      {{ range $session := $sessions }}\n        {{ if $session.Bool \"PlayState.CanSeek\" }}\n          {{ $activeSessions = 1 }}\n          {{ break }}\n        {{ end }}\n      {{ end }}\n    {{ else }}\n      {{ $activeSessions = len $sessions }}\n    {{ end }}\n  {{ else }}\n    {{ template \"errorMsg\" (concat \"Could not fetch \" $mediaServer \" API.\") }}\n  {{ end }}\n{{ end }}\n\n{{ if and (eq $sessionsCall.Response.StatusCode 200) (eq $activeSessions 0) }}\n  <p>Nothing is playing right now.</p>\n{{ else }}\n\n  <style>\n    .media-server-session-container--grid {\n      display: grid;\n      grid-template-columns: repeat(2, 1fr);\n    }\n    @media (max-width: 768px) {\n      .media-server-session-container--grid {\n        display: flex;\n        flex-direction: column;\n      }\n    }\n    .media-server-progress-container {\n      height: 1rem;\n      max-width: 32rem;\n      border: 1px solid var(--color-text-base);\n      border-radius: var(--border-radius);\n      overflow: hidden;\n    }\n    .media-server-progress-bar {\n      height: 100%;\n      background: var(--color-primary);\n      border-radius: 3px;\n      transition: width 1s linear;\n    }\n    @keyframes progress-animation { to { width: 100%; } }\n  </style>\n\n  <div class=\"gap-10 {{ if $isSmallColumn }}flex flex-column{{ else }}media-server-session-container--grid{{ end }}\">\n  {{ range $i, $session := $sessions }}\n    {{ $isClient := true }}\n    {{ $isPlaying := false }}\n    {{ $state := \"playing\" }}\n    {{ $isMovie := false }}\n    {{ $isShows := false }}\n    {{ $isMusic := false }}\n    {{ $userName := \"\" }}\n    {{ $title := \"\" }}\n    {{ $showTitle := \"\" }}\n    {{ $showSeason := \"\" }}\n    {{ $showEpisode := \"\" }}\n    {{ $artist := \"\" }}\n    {{ $albumTitle := \"\" }}\n    {{ $thumbURL := \"\" }}\n    {{ $now := now | formatTime \"15:04:05\" | parseLocalTime \"15:04:05\" }}\n    {{ $duration := 0 }}\n    {{ $offset := 0 }}\n    {{ $remainingSeconds := 0 }}\n\n    {{ if eq $mediaServer \"plex\" }}\n      {{ $isPlaying = eq ($session.String \"Player.state\") \"playing\" }}\n      {{ if not $isPlaying }}\n        {{ $state = \"paused\"}}\n      {{ end }}\n\n      {{ $mediaType := $session.String \"type\" }}\n      {{ $isMovie = eq $mediaType \"movie\" }}\n      {{ $isShows = eq $mediaType \"episode\" }}\n      {{ $isMusic = eq $mediaType \"track\" }}\n\n      {{ $userName = $session.String \"User.title\" }}\n      {{ $title = $session.String \"title\" }}\n      {{ $showTitle = $session.String \"grandparentTitle\" }}\n      {{ $showSeason = $session.String \"parentIndex\" }}\n      {{ $showEpisode = $session.String \"index\" }}\n      {{ $artist = $session.String \"grandparentTitle\" }}\n      {{ $albumTitle = $session.String \"parentTitle\" }}\n\n      {{ $thumbID := $session.String \"thumb\" }}\n      {{ if or $isShows $isMusic }}\n        {{ $thumbID = $session.String \"parentThumb\" }}\n      {{ end }}\n      {{ $thumbURL = concat $baseURL $thumbID \"?X-Plex-Token=\" $apiKey }}\n\n      {{ $duration = $session.Float \"duration\" }}\n      {{ $offset = $session.Float \"viewOffset\" }}\n      {{ $remainingSeconds = div (sub $duration $offset) 1000 | toInt }}\n    {{ else if eq $mediaServer \"tautulli\" }}\n      {{ $isPlaying = eq ($session.String \"state\") \"playing\" }}\n      {{ if not $isPlaying }}\n        {{ $state = \"paused\"}}\n      {{ end }}\n\n      {{ $mediaType := $session.String \"media_type\" }}\n      {{ $isMovie = eq $mediaType \"movie\" }}\n      {{ $isShows = eq $mediaType \"episode\" }}\n      {{ $isMusic = eq $mediaType \"track\" }}\n\n      {{ $userName = $session.String \"user\" }}\n      {{ $title = $session.String \"title\" }}\n      {{ $showTitle = $session.String \"grandparent_title\" }}\n      {{ $showSeason = $session.String \"parent_media_index\" }}\n      {{ $showEpisode = $session.String \"media_index\" }}\n      {{ $artist = $session.String \"grandparent_title\" }}\n      {{ $albumTitle = $session.String \"parent_title\" }}\n\n      {{ $thumbID := $session.String \"thumb\" }}\n      {{ if or $isShows $isMusic }}\n        {{ $thumbID = $session.String \"parent_thumb\" }}\n      {{ end }}\n      {{ $thumbURL = concat $baseURL \"/api/v2?apikey=\" $apiKey \"&cmd=pms_image_proxy&img=\" $thumbID }}\n\n      {{ $duration = $session.Float \"duration\" }}\n      {{ $offset = $session.Float \"view_offset\" }}\n      {{ $remainingSeconds = div (sub $duration $offset) 1000 | toInt }}\n    {{ else if or (eq $mediaServer \"jellyfin\") (eq $mediaServer \"emby\") }}\n      {{ if eq $mediaServer \"emby\" }}\n        {{ $isClient = $session.Bool \"PlayState.CanSeek\" }}\n      {{ end }}\n      {{ $isPlaying = and ($session.Exists \"NowPlayingItem\") (not ($session.Bool \"PlayState.IsPaused\")) }}\n      {{ if not $isPlaying }}\n        {{ $state = \"paused\"}}\n      {{ end }}\n\n      {{ $mediaType := $session.String \"NowPlayingItem.Type\" }}\n      {{ $isMovie = eq $mediaType \"Movie\" }}\n      {{ $isShows = eq $mediaType \"Episode\" }}\n      {{ $isMusic = eq $mediaType \"Audio\" }}\n\n      {{ $userName = $session.String \"UserName\" }}\n      {{ $title = $session.String \"NowPlayingItem.Name\" }}\n      {{ $showTitle = $session.String \"NowPlayingItem.SeriesName\" }}\n      {{ $showSeason = $session.String \"NowPlayingItem.ParentIndexNumber\" }}\n      {{ $showEpisode = $session.String \"NowPlayingItem.IndexNumber\" }}\n      {{ $artist = $session.String \"NowPlayingItem.AlbumArtist\" }}\n      {{ $albumTitle = $session.String \"NowPlayingItem.Album\" }}\n\n      {{ $thumbID := $session.String \"NowPlayingItem.Id\" }}\n      {{ if $isShows }}\n        {{ $thumbID = $session.String \"NowPlayingItem.ParentId\" }}\n      {{ end }}\n      {{ $thumbURL = concat $baseURL \"/Items/\" $thumbID \"/Images/Primary?api_key=\" $apiKey }}\n\n      {{ $duration = $session.Float \"NowPlayingItem.RunTimeTicks\" }}\n      {{ $offset = $session.Float \"PlayState.PositionTicks\" }}\n      {{ $remainingSeconds = div (sub $duration $offset) 10000000 | toInt }}\n    {{ end }}\n\n    {{ $progress := mul 100 (div $offset $duration) | toInt }}\n    {{ $endTime := $now.Add (duration (printf \"%ds\" $remainingSeconds)) | formatTime $timeFormat }}\n\n    {{ $showInfoFormat := concat \"Season \" $showSeason \" Episode \" $showEpisode}}\n    {{ if $isCompact }}\n      {{ $showInfoFormat = concat \"S\" $showSeason \"E\" $showEpisode}}\n    {{ end }}\n\n    {{ if and $isClient (or $isPlaying $showPaused) }}\n    <div class=\"card gap-5\">\n      <div class=\"flex items-center gap-10 size-h3\">\n        <span class=\"color-primary\">{{ $userName }}</span>\n        {{ if eq $playState \"text\" }}\n          <span {{ if $isPlaying }}class=\"color-primary\"{{ end }}>\n            [{{ $state }}]\n          </span>\n        {{ else if eq $playState \"indicator\" }}\n          <style>\n            .media-server-indicator {\n              height: .7rem;\n              width: .7rem;\n              border-radius: 100%;\n              {{ if $isPlaying }}\n                animation: pulse 5s infinite;\n                background: var(--color-primary);\n              {{ else }}\n                background: var(--color-text-base-muted);\n              {{ end }}\n            }\n            @keyframes pulse {\n              0% { box-shadow: 0 0 0 0 var(--color-text-base); }\n              40% { box-shadow: 0 0 0 4px transparent; }\n              100% { box-shadow: 0 0 0 4px transparent; }\n            }\n          </style>\n          <div class=\"media-server-indicator\"></div>\n        {{ end }}\n      </div>\n\n      <hr class=\"margin-bottom-5\" />\n\n      <div class=\"flex items-center gap-10\" style=\"align-items: stretch;\">\n        {{ if $showThumbnail }}\n          <img src=\"{{ $thumbURL | safeURL }}\"\n            alt=\"{{ $title }} thumbnail\"\n            class=\"shrink-0\"\n            loading=\"lazy\"\n            style=\"\n              max-width: 7.5rem;\n              border: 2px solid var(--color-primary);\n              border-radius: var(--border-radius);\n              object-fit: cover;\n              {{ if and $isCompact (not $fullThumbnail) }} aspect-ratio: 1; {{ end }} \"\n          />\n        {{ end }}\n        <ul class=\"flex flex-column grow justify-evenly\" style=\"width: 0;\">\n          {{ if $isCompact }}\n            {{ if $isShows }}\n              <ul class=\"list-horizontal-text flex-nowrap\">\n                <li class=\"shrink-0\">{{ concat \"S\" $showSeason \"E\" $showEpisode }}</li>\n                <li class=\"text-truncate\">{{ $showTitle }}</li>\n              </ul>\n            {{ else if $isMusic }}\n              <ul class=\"list-horizontal-text flex-nowrap\">\n                <li class=\"shrink-0\">{{ $artist }}</li>\n                <li class=\"text-truncate\">{{ $albumTitle }}</li>\n              </ul>\n            {{ end }}\n            <li class=\"text-truncate\">{{ $title }}</li>\n          {{ else }}\n            {{ if $isShows }}\n              <li>{{ $showTitle }}</li>\n              <li>{{ concat \"S\" $showSeason \"E\" $showEpisode }}</li>\n            {{ else if $isMusic }}\n              <li>{{ $artist }}</li>\n              <li>{{ $albumTitle }}</li>\n            {{ end }}\n            <li>{{ $title }}</li>\n          {{ end }}\n\n          <li>\n            {{ if and $isPlaying $showProgressBar }}\n              <div class=\"flex gap-10 items-center\">\n                <div class=\"media-server-progress-container grow\">\n                  <div\n                    class =\"media-server-progress-bar\"\n                    data-progress=\"{{ $progress }}\"\n                    data-remaining=\"{{ $remainingSeconds }}\"\n                    style=\"\n                      width: {{ $progress }}%;\n                      animation: progress-animation {{ $remainingSeconds }}s linear forwards;\"\n                  >\n                  </div>\n                </div>\n                {{ if $showProgressInfo }}\n                  <p>\n                    {{ if and (not $isCompact) (not $isSmallColumn) }}\n                      ends at \n                    {{ end }}\n                    {{ $endTime }}\n                  </p>\n                {{ end }}\n              </div>\n            {{ end }}\n          </li>\n        </ul>\n      </div>\n    </div>\n    {{ end }}\n  {{ end }}\n</div>\n{{ end }}\n{{ end }}";
}
